
Load the files: the new employees data and the hays data

```{r}
data <- read.csv(file = "employees2.csv", fileEncoding="UTF-8-BOM")
income_data <- read.csv(file = "hays_salary_survey.csv")[-c(2,3,4)] #use post tax figures

```
map the industry income ranges to our data

```{r}
lower <- income_data[match(data$JobRole,income_data$JobRole),][2]
upper <- income_data[match(data$JobRole,income_data$JobRole),][3]

#classify the monthly income
data$IndustryRange <- ifelse(
data$MonthlyIncome < lower,
"Below Range",
ifelse(
data$MonthlyIncome >= lower & data$MonthlyIncome< upper,
"Within Range",
"Above Range")
)
```
Enrich the data

```{r}
data$IsAttrition <- ifelse(data$Attrition == "Yes",1,0) 

data$IsManagement <- ifelse(
  data$JobRole == c("Manager", "Manufacturing Director", 
                    "Research Director", "Sales Executive"),
  "Yes",
  "No"
)
```

Linear Model lmIncome

```{r}
numRows <- nrow(data)
set.seed(60) #changed from 57
train <- sample(numRows, 0.8*numRows)
dataTrain <- data[train, ]
dataTest <- data[-train,]

```

Linear modelling Linear.Model.01

```{r}
Linear.Model.01 <- lm(
formula = YearsAtCompany ~ .,
data = dataTrain
)
summary(Linear.Model.01)

```
Use leaps package to work out which combinations best explain target

```{r}
library(leaps)
bestSubset <- regsubsets(
YearsAtCompany ~ .,
data = dataTrain,
nvmax = 24 #number of dependant variables
)
summary(bestSubset)
```

```{r}
coef(bestSubset, 1:24)
```

```{r}
summary(bestSubset)$bic # Get all of the adjusted R^2 values
```
Judging which model is best there are different metrics

```{r}
which.max(summary(bestSubset)$adjr2)
which.min(summary(bestSubset)$rss)
which.min(summary(bestSubset)$cp)
which.min(summary(bestSubset)$bic)
```
Plotting the best(bic, for example) measure

```{r}
plot(
summary(bestSubset)$bic,
type = "l",
main = "No variables by BIC",
xlab = "Number of Variables",
ylab = "BIC",
)

bestBIC = which.min(summary(bestSubset)$bic)
points(    #showing the point with lowest bic for example
x = bestBIC,
y = summary(bestSubset)$bic[bestBIC],
col = "red",
pch = "x"
)
```

```{r}
coef(bestSubset, 5)
coef(bestSubset, 17)
coef(bestSubset, 22)
```
```{r}
#linear models deemed by by regsubsets, bic and c scores
#best 5
Linear.Model.02 <- lm(
            formula = YearsAtCompany ~ NumCompaniesWorked + TotalWorkingYears + YearsInCurrentRole +     YearsSinceLastPromotion + YearsWithCurrManager ,
            data = dataTrain,
            
)

#best 17
Linear.Model.03 <- lm(
            formula = YearsAtCompany ~ Department+DistanceFromHome+EnvironmentSatisfaction+Gender+
                JobInvolvement+JobRole+NumCompaniesWorked+RelationshipSatisfaction+TotalWorkingYears+
                YearsInCurrentRole+YearsSinceLastPromotion +YearsWithCurrManager+IndustryRange+IsManagement,
            data = dataTrain,
            
)

#Best 22

Linear.Model.04 <- lm(
            formula = YearsAtCompany ~ Age+Department+DistanceFromHome+EnvironmentSatisfaction+
                Gender+JobInvolvement+JobRole+NumCompaniesWorked+
                PerformanceRating+RelationshipSatisfaction+StockOptionLevel+
                TotalWorkingYears+TrainingTimesLastYear+WorkLifeBalance+
                YearsInCurrentRole+YearsSinceLastPromotion+YearsWithCurrManager+
                IndustryRange+IsManagement,
            data = dataTrain,
            
)



```
```{r}
#final test on linear models deemed by by regsubsets, bic and c scores
dataTest$PredictionYears.lm02 <- predict(
                                  Linear.Model.02,
                                  newdata = dataTest,
                                  type = "response"
)
dataTest$PredictionYears.lm03 <- predict(
                                  Linear.Model.03,
                                  newdata = dataTest,
                                  type = "response"
)

dataTest$PredictionYears.lm02 <- predict(
                                  Linear.Model.02,
                                  newdata = dataTest,
                                  type = "response"
)
dataTest$PredictionYears.lm04 <- predict(
                                  Linear.Model.04,
                                  newdata = dataTest,
                                  type = "response"
)

mean((dataTest$YearsAtCompany - dataTest$PredictionYears.lm02)^2) #least so it is best
mean((dataTest$YearsAtCompany - dataTest$PredictionYears.lm03)^2)
mean((dataTest$YearsAtCompany - dataTest$PredictionYears.lm04)^2)

#what about on train data

dataTrain$PredictionYears.lm02 <- predict(
                                  Linear.Model.02,
                                  newdata = dataTrain,
                                  type = "response"
)
dataTrain$PredictionYears.lm03 <- predict(
                                  Linear.Model.03,
                                  newdata = dataTrain,
                                  type = "response"
)

mean((dataTrain$YearsAtCompany - dataTrain$PredictionYears.lm02)^2) #least so it is best
mean((dataTrain$YearsAtCompany - dataTrain$PredictionYears.lm03)^2)

```
```{r}
barplot(
    dataTest$YearsAtCompany,
    col = "red",

)
barplot(
    dataTest$PredictionYears.lm02,
    col = "blue",
    add = TRUE
    
)
```


Logistic model logmod


```{r}
#gml model with all variables 
gLinear.Model.05 <- glm(
          IsAttrition ~  Age +BusinessTravel +Department + 
                         DistanceFromHome +Education + EnvironmentSatisfaction + 
                         Gender + JobInvolvement + JobRole + 
                         MaritalStatus + MonthlyIncome + NumCompaniesWorked + 
                         OverTime + PerformanceRating +StockOptionLevel +
                         TotalWorkingYears +TrainingTimesLastYear +WorkLifeBalance +
                         YearsAtCompany  +YearsInCurrentRole + YearsSinceLastPromotion  +
                         YearsWithCurrManager +IndustryRange ,
    data = dataTrain,
    family = binomial,
    control = list(maxit = 27)
)

summary(gLinear.Model.05)

gLinear.Model.06 <- glm(
          IsAttrition ~ Age +DistanceFromHome + EnvironmentSatisfaction + 
                        JobInvolvement + JobRole + MaritalStatus  + 
                        NumCompaniesWorked + OverTime   +YearsInCurrentRole + 
                        YearsSinceLastPromotion  +YearsWithCurrManager +RelationshipSatisfaction,
    data = dataTrain,
    family = binomial,
    control = list(maxit = 27)
)
summary(gLinear.Model.06)
```


gLm preditions

```{r}
dataTest$ProbabilityAttrition05 <- predict(
        gLinear.Model.05,
        newdata = dataTest,
        type = "response"
)

dataTest$ProbabilityAttrition06 <- predict(
        gLinear.Model.06,
        newdata = dataTest,
        type = "response"
)

dataTest$PredictionAttrition05 <- ifelse(dataTest$ProbabilityAttrition05 > 0.5, 1, 0)
dataTest$PredictionAttrition06 <- ifelse(dataTest$ProbabilityAttrition06 > 0.5, 1, 0)

boxplot(
  dataTest$ProbabilityAttrition06 ~ dataTest$Attrition
  
)

boxplot(
  dataTest$ProbabilityAttrition05 ~ dataTest$Attrition
  
)
#Confusion matrix 

conf_matrixAll <- table(dataTest$PredictionAttrition05, dataTest$IsAttrition)
accuracy.gLinear.Model.05.test <- sum(diag(conf_matrixAll))/sum(conf_matrixAll)
accuracy.gLinear.Model.05.test

conf_matrixSig <- table(dataTest$PredictionAttrition06, dataTest$IsAttrition)
accuracy.gLinear.Model.06.test <- sum(diag(conf_matrixSig))/sum(conf_matrixSig)
accuracy.gLinear.Model.06.test
```

Accuracy on Train data

```{r}
dataTrain$ProbabilityAttrition05 <- predict(
        gLinear.Model.05,
        newdata = dataTrain,
        type = "response"
)

dataTrain$ProbabilityAttrition06 <- predict(
        gLinear.Model.06,
        newdata = dataTrain,
        type = "response"
)

dataTrain$PredictionAttrition05 <- ifelse(dataTrain$ProbabilityAttrition05 > 0.5, 1, 0)
dataTrain$PredictionAttrition06 <- ifelse(dataTrain$ProbabilityAttrition06 > 0.5, 1, 0)

#Confusion matrix 

(conf_matrixAll.train <- table(dataTrain$PredictionAttrition05, dataTrain$IsAttrition))
accuracy.gLinear.Model.05.train <- sum(diag(conf_matrixAll.train))/sum(conf_matrixAll.train)
accuracy.gLinear.Model.05.train

conf_matrixSig.train <- table(dataTrain$PredictionAttrition06, dataTrain$IsAttrition)
accuracy.gLinear.Model.06.train <- sum(diag(conf_matrixSig.train))/sum(conf_matrixSig.train)
accuracy.gLinear.Model.06.train
```

Modelling with a Decision Tree

```{r}

library(rpart)
library(rpart.plot)
tree <- rpart(
            Attrition ~ Age +BusinessTravel +Department + 
              DistanceFromHome + Education + EnvironmentSatisfaction + 
              Gender + JobInvolvement + JobRole + MaritalStatus + 
              MonthlyIncome + NumCompaniesWorked + OverTime + 
              PerformanceRating +StockOptionLevel +TotalWorkingYears +
              TrainingTimesLastYear +WorkLifeBalance +YearsAtCompany  +
              YearsInCurrentRole + YearsSinceLastPromotion  +YearsWithCurrManager +
              IndustryRange + RelationshipSatisfaction + IsManagement,
        data = dataTrain,
        method = "class",
        #parms=list(split="gini"),
        minsplit=20, #smallest number of observations in the parent node that could be split further.default is 20.
        minbucket = 1 #smallest number of observations that are allowed in a terminal node
)

rpart.plot(tree)
tree

```
```{r}
dataTest$PredictionTree <-predict(
  tree,
  newdata = dataTest,
  type = "class"
)

conf_matrixTree <- table(dataTest$PredictionTree, dataTest$Attrition)
accuracy.Tree.test <- sum(diag(conf_matrixTree))/sum(conf_matrixTree)
accuracy.Tree.test

dataTrain$PredictionTree <-predict(
  tree,
  newdata = dataTrain,
  type = "class"
)

conf_matrixTree.train <- table(dataTrain$PredictionTree, dataTrain$Attrition)
accuracy.Tree.train <- sum(diag(conf_matrixTree.train))/sum(conf_matrixTree.train)
accuracy.Tree.train

```
Random forest

```{r}

library(randomForest)
require(caTools)
random.forest <- randomForest(
  IsAttrition ~ Age +BusinessTravel +Department + DistanceFromHome +
                Education + EnvironmentSatisfaction + Gender + 
                JobInvolvement + JobRole + MaritalStatus + 
                MonthlyIncome + NumCompaniesWorked + OverTime + 
                PerformanceRating +StockOptionLevel +TotalWorkingYears +
                TrainingTimesLastYear +WorkLifeBalance +YearsAtCompany  +
                YearsInCurrentRole + YearsSinceLastPromotion  +YearsWithCurrManager +
                IndustryRange + IsManagement,
  data = dataTrain,
  parms=list(split="gini")
)

dataTest$PredRF.probability <-predict(
                random.forest,
                newdata = dataTest
                
)
dataTest$PredRF <- ifelse(dataTest$PredRF.probability > 0.5, 1, 0)

conf_matrixRF.test <- table(dataTest$PredRF, dataTest$IsAttrition)
accuracy.RF.test <- sum(diag(conf_matrixRF.test))/sum(conf_matrixRF.test)
accuracy.RF.test

boxplot(
  dataTest$PredRF.probability ~ dataTest$Attrition
  
)



```
What about on training set

```{r}
dataTrain$PredRF.probability <-predict(
                random.forest,
                newdata = dataTrain,
                
)
dataTrain$PredRF <- ifelse(dataTrain$PredRF.probability > 0.5, 1, 0)

conf_matrixRF.Train <- table(dataTrain$PredRF, dataTrain$IsAttrition)
accuracy.RF.Train <- sum(diag(conf_matrixRF.Train))/sum(conf_matrixRF.Train)
accuracy.RF.Train
```
```{r}
#plot of the models perfomance
par(mfrow = c(2,2))
library(vcd)
mosaic(
  structable(conf_matrixAll),
  labeling = labeling_values, 
  pop = FALSE, 
  main = "Confusion Matrix (Test) for model gLinear.Model.05")

mosaic(
  structable(conf_matrixSig),
  labeling = labeling_values, 
  pop = FALSE, 
  main = "Confusion Matrix (Test) for model gLinear.Model.06")

mosaic(
  structable(conf_matrixTree),
  labeling = labeling_values, 
  pop = FALSE, 
  main = "Confusion Matrix (Test) for model Decision Tree")

mosaic(
  structable(conf_matrixRF.test),
  labeling = labeling_values, 
  pop = FALSE, 
  main = "Confusion Matrix (Test) for model Random Forest RF")
```
Comparing LMs and GLMs
```{r}
library("rcompanion")
compareLM(Linear.Model.01,Linear.Model.02,Linear.Model.03)
compareGLM(gLinear.Model.05,gLinear.Model.06)
```
```{r}
atRisk <- subset(
                dataTest,
                (dataTest$YearsAtCompany+1.5) > dataTest$PredictionYears.lm02
                )
table(dataTest$Attrition)
table(atRisk$Attrition)
```







